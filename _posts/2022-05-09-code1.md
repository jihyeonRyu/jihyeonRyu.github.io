---
layout: post   
title: Pytorch To Onnx Convert Error     
subtitle: Bug Fix       
tags: [programming, pytorch, onnx]  
comments: true  
---   

## Torch.inverse() Can't export ONNX

ONNX에서 torch.inverse (역함수 행렬) 구하는 연산이 지원되지 않아 변환시 에러가 발생한다.  
아래 코드를 통해 torch.inverse()를 대체할 수 있다.  
단, batch 별로 serial 하게 수행하기 때문에 병렬 연산엔 효율적이진 못하다. 

* Code 

```python

import torch

device = torch.device("cpu" if not torch.cuda.is_available() else "cuda:0")

############### Torch Inverse #################

def cof1(M, index):
    zs = M[:index[0]-1, :index[1]-1]
    ys = M[:index[0]-1, index[1]:]
    zx = M[index[0]:, :index[1]-1]
    yx = M[index[0]:, index[1]:]
    s = torch.cat([zs, ys], axis=1)
    x = torch.cat([zx, yx], axis=1)
    return torch.det(torch.cat([s, x], axis=0))


def alcof(M, index):
    return pow(-1, index[0]+index[1]) * cof1(M, index)

def adj(M):

    result = torch.zeros(M.shape).to(device)
    for i in range(1, M.shape[0]+1):
        for j in range(1, M.shape[1]+1):
            result[j-1][i-1] = alcof(M,[i, j])
    return result

def invmat(M):

    result = torch.zeros(M.shape).to(device)
    for batch in range(M.shape[0]):
        result[batch] = 1.0/torch.det(M[batch])*adj(M[batch])
    return result

if __name__ == "__main__":

    M = torch.randn((3, 4, 4))
    print(M)
    print(torch.inverse(M))
    print(invmat(M))

```

* requirements
  * opset_version == 14 로 설정한다 (이하 버전에서는 torch.det() opperation이 지원되지 않음)
    
```python
torch.onnx.export(model, (inputs, ), 
                  "model.onnx", 
                  input_names=['inputs'],
                  output_names=['outputs'],
                  opset_version=14)
```


## F.grid_sample() Can't export ONNX

완전히 같은 값은 아니지만 precision < 5 이하의 작은 오차로 비슷한 연산으로 대체할 수 있다.

* pre-requirements
    * torch version == 1.10

```bash
pip install mmcv-full==1.4.5 -f https://download.openmmlab.com/mmcv/dist/cu113/torch1.10/index.html
```

* Code

```python
############# Torch Grid Sampler ##################
import torch
import torch.nn.functional as F
from mmcv.ops.point_sample import bilinear_grid_sample

# Toy model including blinear_grid_sampler
class Sampler(torch.nn.Module):
    def __init__(self):
        super().__init__()

    def forward(self, x, grid):
        return bilinear_grid_sample(x, grid, align_corners=False)


if __name__ == "__main__":

    # sample input and grid
    x = torch.randn(1, 4, 10, 10)
    grid = 2 * torch.rand(1, 8, 8, 2) - 1  # scale as (-1, 1)

    # reference output
    ref = F.grid_sample(x, grid, align_corners=False)
    # substitute output
    out = bilinear_grid_sample(x, grid, align_corners=False)
    # almost the same
    diff = out-ref
    torch.set_printoptions(precision=5, sci_mode=False)
    print(diff)

```

